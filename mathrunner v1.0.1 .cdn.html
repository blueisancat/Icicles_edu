<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prime Runner - Math Game - BY blueisancat</title>
    <meta name="description" content="A fast-paced math game where you dodge composite numbers and collect primes!">
    <meta name="keywords" content="math game, prime numbers, educational game, runner game">
    <meta property="og:title" content="Prime Runner">
    <meta property="og:description" content="Dodge composites, collect primes!">
    <meta property="og:image" content="https://raw.githubusercontent.com/yourusername/prime-runner-game/main/assets/thumbnail.png">
    <meta name="twitter:card" content="summary_large_image">
    
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üéÆ</text></svg>">
    
    <style>
        /* Reset and Base Styles */
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: #000;
            color: white;
            overflow: hidden;
            height: 100vh;
            width: 100vw;
            position: fixed;
            touch-action: none;
            user-select: none;
        }
        
        canvas { 
            display: block; 
            position: fixed;
            top: 0;
            left: 0;
            z-index: 1;
            width: 100% !important;
            height: 100% !important;
        }
        
        /* Loader Screen */
        #loader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            transition: opacity 0.5s;
        }
        
        .loader-content {
            text-align: center;
            padding: 20px;
        }
        
        .loader-title {
            font-size: 3em;
            margin-bottom: 20px;
            background: linear-gradient(90deg, #00d2ff, #00ff00);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            text-shadow: 0 0 30px rgba(0, 210, 255, 0.5);
        }
        
        .loader-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #333;
            border-top: 4px solid #00d2ff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 30px auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .loader-progress {
            width: 200px;
            height: 4px;
            background: #333;
            border-radius: 2px;
            margin: 20px auto;
            overflow: hidden;
        }
        
        .loader-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #00d2ff, #00ff00);
            width: 0%;
            transition: width 0.3s;
        }
        
        .loader-tip {
            color: #666;
            font-size: 14px;
            margin-top: 20px;
            max-width: 300px;
        }
        
        /* UI Elements */
        .ui-container {
            position: fixed;
            pointer-events: none;
            z-index: 10;
            width: 100%;
            height: 100%;
        }
        
        /* HUD - Optimized for mobile */
        #hud {
            position: fixed;
            top: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.8);
            padding: 12px;
            border-radius: 12px;
            border: 2px solid #00d2ff;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            transform: translateY(0);
            opacity: 1;
            transition: all 0.3s;
            pointer-events: auto;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
        }
        
        @media (max-width: 768px) {
            #hud {
                padding: 8px;
                left: 5px;
                top: 5px;
                transform: scale(0.9);
                transform-origin: top left;
            }
        }
        
        .hud-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 6px 0;
            min-width: 160px;
        }
        
        @media (max-width: 768px) {
            .hud-item {
                min-width: 140px;
            }
        }
        
        .hud-label {
            color: #00d2ff;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 14px;
        }
        
        .hud-value {
            color: #000;
            font-weight: bold;
            padding: 4px 10px;
            background: #00ff00;
            border-radius: 15px;
            min-width: 60px;
            text-align: center;
            font-size: 14px;
            box-shadow: 0 0 10px rgba(0, 255, 0, 0.5);
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
        }
        
        /* Controls for Mobile */
        .mobile-controls {
            position: fixed;
            bottom: 20px;
            width: 100%;
            display: flex;
            justify-content: space-between;
            padding: 0 20px;
            pointer-events: auto;
            z-index: 50;
        }
        
        @media (min-width: 769px) {
            .mobile-controls {
                display: none;
            }
        }
        
        .control-button {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            background: rgba(0, 210, 255, 0.2);
            border: 2px solid #00d2ff;
            color: white;
            font-size: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            touch-action: manipulation;
            user-select: none;
            -webkit-user-select: none;
        }
        
        .control-button:active {
            background: rgba(0, 210, 255, 0.4);
            transform: scale(0.95);
        }
        
        /* Menu System */
        .screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
            opacity: 0;
            visibility: hidden;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            padding: 20px;
            overflow-y: auto;
        }
        
        .screen.active {
            opacity: 1;
            visibility: visible;
        }
        
        .menu-container {
            max-width: 600px;
            width: 100%;
            padding: 30px;
            background: rgba(0, 0, 0, 0.7);
            border-radius: 20px;
            border: 3px solid #00d2ff;
            box-shadow: 0 20px 60px rgba(0, 210, 255, 0.3);
            text-align: center;
            animation: menuSlide 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        @keyframes menuSlide {
            from { transform: translateY(30px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .game-title {
            font-size: 3.5em;
            margin-bottom: 10px;
            background: linear-gradient(90deg, #00d2ff, #00ff00);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            text-shadow: 0 0 40px rgba(0, 210, 255, 0.5);
        }
        
        @media (max-width: 768px) {
            .game-title {
                font-size: 2.5em;
            }
            .menu-container {
                padding: 20px;
                margin: 10px;
            }
        }
        
        .game-subtitle {
            color: #00d2ff;
            font-size: 1.2em;
            margin-bottom: 30px;
            opacity: 0.9;
        }
        
        .btn {
            background: linear-gradient(90deg, #00d2ff, #00ff00);
            border: none;
            color: #000;
            padding: 18px 40px;
            font-size: 1.2em;
            border-radius: 15px;
            cursor: pointer;
            margin: 10px;
            font-weight: bold;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            min-width: 200px;
            touch-action: manipulation;
        }
        
        .btn:hover, .btn:active {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(0, 210, 255, 0.5);
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }
        
        .mode-select {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        
        .mode-btn {
            background: rgba(0, 210, 255, 0.1);
            border: 2px solid #00d2ff;
            color: white;
            padding: 12px 24px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
            min-width: 120px;
        }
        
        .mode-btn:hover {
            background: rgba(0, 210, 255, 0.3);
        }
        
        .mode-btn.active {
            background: #00d2ff;
            color: #000;
            box-shadow: 0 0 20px #00d2ff;
        }
        
        /* Shop & Leaderboard Modals */
        .modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.9);
            background: rgba(0, 0, 0, 0.95);
            border: 3px solid #00d2ff;
            border-radius: 25px;
            padding: 30px;
            max-width: 800px;
            width: 95%;
            max-height: 80vh;
            overflow-y: auto;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 30px 80px rgba(0, 210, 255, 0.3);
        }
        
        .modal.active {
            opacity: 1;
            visibility: visible;
            transform: translate(-50%, -50%) scale(1);
        }
        
        .close-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #ff4444;
            color: white;
            border: none;
            font-size: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            z-index: 1001;
        }
        
        .close-btn:hover {
            transform: rotate(90deg) scale(1.1);
            background: #ff0000;
        }
        
        /* Overlay */
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            z-index: 999;
            opacity: 0;
            visibility: hidden;
            transition: all 0.4s;
        }
        
        .overlay.active {
            opacity: 1;
            visibility: visible;
        }
        
        /* Shop Items Grid */
        .shop-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }
        
        @media (max-width: 768px) {
            .shop-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 15px;
            }
        }
        
        .shop-item {
            background: rgba(0, 210, 255, 0.1);
            border: 2px solid #00d2ff;
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }
        
        .shop-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 210, 255, 0.3);
        }
        
        .shop-item.equipped {
            border-color: #00ff00;
            background: rgba(0, 255, 0, 0.1);
        }
        
        .item-preview {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--item-color);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            margin-bottom: 10px;
        }
        
        /* Leaderboard */
        .leaderboard-entries {
            max-height: 400px;
            overflow-y: auto;
            margin: 20px 0;
            padding-right: 10px;
        }
        
        .leaderboard-entry {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            margin: 10px 0;
            background: rgba(0, 210, 255, 0.1);
            border-radius: 10px;
            border: 1px solid rgba(0, 210, 255, 0.3);
        }
        
        /* Game Over Screen */
        .game-over-title {
            font-size: 4em;
            color: #ff4444;
            margin-bottom: 20px;
            text-shadow: 0 0 30px rgba(255, 68, 68, 0.5);
        }
        
        @media (max-width: 768px) {
            .game-over-title {
                font-size: 2.5em;
            }
        }
        
        /* Instructions */
        .instructions {
            color: #aaa;
            font-size: 0.9em;
            max-width: 500px;
            margin: 30px auto;
            line-height: 1.6;
            text-align: center;
        }
        
        /* Performance optimizations */
        .will-change {
            will-change: transform, opacity;
        }
        
        /* Hide elements that should be hidden */
        [hidden] {
            display: none !important;
        }
        
        /* Print styles */
        @media print {
            .no-print {
                display: none !important;
            }
        }
        
        /* Reduced motion */
        @media (prefers-reduced-motion: reduce) {
            * {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }
    </style>
</head>
<body>
    <!-- Loader Screen -->
    <div id="loader">
        <div class="loader-content">
            <h1 class="loader-title">Prime Runner</h1>
            <div class="loader-spinner"></div>
            <div class="loader-progress">
                <div class="loader-progress-bar" id="progressBar"></div>
            </div>
            <p id="loadingText">Loading game assets...</p>
            <p class="loader-tip">üéÆ Use arrow keys or A/D to move<br>üéØ Collect primes, dodge composites</p>
        </div>
    </div>
    
    <!-- Game Container -->
    <div id="game-container"></div>
    
    <!-- UI Container -->
    <div class="ui-container">
        <!-- HUD -->
        <div id="hud" hidden>
            <div class="hud-item">
                <span class="hud-label">üìè DISTANCE</span>
                <span id="dist-val" class="hud-value">0m</span>
            </div>
            <div class="hud-item">
                <span class="hud-label">‚≠ê SCORE</span>
                <span id="score-val" class="hud-value">0</span>
            </div>
            <div class="hud-item">
                <span class="hud-label">ü™ô COINS</span>
                <span id="coins-val" class="hud-value">0</span>
            </div>
            <div class="hud-item">
                <span class="hud-label">‚ö° SPEED</span>
                <span id="speed-val" class="hud-value">0.30</span>
            </div>
        </div>
        
        <!-- Mobile Controls -->
        <div class="mobile-controls" hidden>
            <button class="control-button" id="leftBtn" ontouchstart="moveLeft()" ontouchend="stopMove()">
                ‚Üê
            </button>
            <button class="control-button" id="rightBtn" ontouchstart="moveRight()" ontouchend="stopMove()">
                ‚Üí
            </button>
        </div>
    </div>
    
    <!-- Main Menu -->
    <div id="menu" class="screen active">
        <div class="menu-container">
            <h1 class="game-title">PRIME RUNNER</h1>
            <p class="game-subtitle">Dodge composites, collect primes!</p>
            
            <div class="mode-select">
                <button class="mode-btn active" onclick="setGameMode('normal')">NORMAL</button>
                <button class="mode-btn" onclick="setGameMode('slowburn')">SLOWBURN</button>
                <button class="mode-btn" onclick="setGameMode('hardcore')">HARDCORE</button>
            </div>
            
            <button class="btn" onclick="startGame()">
                üöÄ START GAME
            </button>
            
            <div style="display: flex; gap: 10px; margin: 20px 0; flex-wrap: wrap; justify-content: center;">
                <button class="btn" onclick="openShop()" style="min-width: 150px;">
                    üõí SHOP
                </button>
                <button class="btn" onclick="openLeaderboard()" style="min-width: 150px;">
                    üèÜ LEADERBOARD
                </button>
            </div>
            
            <button class="btn" onclick="toggleSoundSettings()" style="background: linear-gradient(90deg, #8a2be2, #9370db);">
                üéµ SOUND SETTINGS
            </button>
            
            <div class="instructions">
                <strong>üéÆ CONTROLS:</strong> ‚Üê ‚Üí or A D to move | SPACE: Pause | ESC: Menu<br>
                <strong>üéØ GOAL:</strong> Collect Prime Numbers (green), dodge Composite Numbers (red)
            </div>
            
            <div style="margin-top: 30px; color: #666; font-size: 12px;">
                Made with ‚ù§Ô∏è for math education
            </div>
        </div>
    </div>
    
    <!-- Name Input -->
    <div id="name-prompt" class="screen">
        <div class="menu-container">
            <h2 style="color: #00d2ff; margin-bottom: 20px;">üë§ ENTER YOUR NAME</h2>
            <input type="text" id="username-input" maxlength="15" placeholder="Enter your name" 
                   style="background: rgba(255,255,255,0.1); border: 2px solid #00d2ff; color: white; padding: 15px; font-size: 18px; border-radius: 10px; width: 100%; max-width: 300px; text-align: center; margin: 20px;">
            <button class="btn" onclick="saveUsername()">
                START GAME
            </button>
        </div>
    </div>
    
    <!-- Game Over -->
    <div id="game-over" class="screen">
        <div class="menu-container">
            <h2 class="game-over-title">üíÄ GAME OVER</h2>
            <div id="reason" style="color: #ff4444; font-size: 1.5em; margin: 20px;"></div>
            <div id="final-stats" style="color: #00d2ff; font-size: 1.2em; margin: 10px;"></div>
            <div id="coins-earned" style="color: #ffd700; font-size: 1.5em; margin: 20px;"></div>
            
            <button class="btn" onclick="backToMenu()" style="margin: 10px;">
                üè† MAIN MENU
            </button>
            <button class="btn" onclick="restartGame()" style="background: linear-gradient(90deg, #ff4444, #ff8800); margin: 10px;">
                üîÑ PLAY AGAIN
            </button>
        </div>
    </div>
    
    <!-- Shop Modal -->
    <div id="shop" class="modal">
        <button class="close-btn" onclick="closeShop()">√ó</button>
        <div class="menu-container" style="border: none; padding: 0; background: none; box-shadow: none;">
            <h2 style="color: #ffd700; margin-bottom: 10px;">üõí SKIN SHOP</h2>
            <p style="color: #00d2ff; margin-bottom: 20px;">Your coins: <span id="shop-coins" style="color: #ffd700; font-weight: bold;">0</span></p>
            
            <div id="shop-items" class="shop-grid"></div>
            
            <button class="btn" onclick="closeShop()" style="margin-top: 30px; background: linear-gradient(90deg, #666, #888);">
                ‚Üê BACK
            </button>
        </div>
    </div>
    
    <!-- Leaderboard Modal -->
    <div id="leaderboard" class="modal">
        <button class="close-btn" onclick="closeLeaderboard()">√ó</button>
        <div class="menu-container" style="border: none; padding: 0; background: none; box-shadow: none;">
            <h2 style="color: #00ff00; margin-bottom: 20px;">üèÜ LEADERBOARD</h2>
            
            <div id="lb-entries" class="leaderboard-entries"></div>
            
            <button class="btn" onclick="closeLeaderboard()" style="margin-top: 20px;">
                CLOSE
            </button>
        </div>
    </div>
    
    <!-- Sound Settings Modal -->
    <div id="sound-settings" class="modal">
        <button class="close-btn" onclick="closeSoundSettings()">√ó</button>
        <div class="menu-container" style="border: none; padding: 0; background: none; box-shadow: none;">
            <h2 style="color: #00ff00; margin-bottom: 20px;">üéµ SOUND SETTINGS</h2>
            
            <div style="text-align: left; margin: 30px 0;">
                <div style="margin: 20px 0;">
                    <label style="display: block; color: white; margin-bottom: 10px;">üîä Master Volume</label>
                    <input type="range" min="0" max="100" value="100" id="master-volume" style="width: 100%;">
                </div>
                
                <div style="margin: 20px 0;">
                    <label style="display: flex; align-items: center; color: white; gap: 10px;">
                        <input type="checkbox" id="sound-toggle" checked style="width: 20px; height: 20px;">
                        üîä Game Sounds
                    </label>
                </div>
                
                <div style="margin: 20px 0;">
                    <label style="display: flex; align-items: center; color: white; gap: 10px;">
                        <input type="checkbox" id="music-toggle" checked style="width: 20px; height: 20px;">
                        üéµ Background Music
                    </label>
                </div>
            </div>
            
            <button class="btn" onclick="saveSoundSettings()">
                SAVE SETTINGS
            </button>
        </div>
    </div>
    
    <!-- Overlay -->
    <div id="overlay" class="overlay"></div>
    
    <!-- Three.js from CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    
    <script>
        // ==================== GAME CONFIGURATION ====================
        const CONFIG = {
            version: '1.0.0',
            githubRepo: 'https://github.com/yourusername/prime-runner-game',
            defaultCoins: 100,
            localStoragePrefix: 'primeRunner_'
        };
        
        // Game State
        let gameState = {
            scene: null,
            camera: null,
            renderer: null,
            player: null,
            playerCore: null,
            road: null,
            grid: null,
            pillars: [],
            activeNumbers: [],
            isPlaying: false,
            isPaused: false,
            isInitialized: false,
            score: 0,
            distance: 0,
            speed: 0.3,
            coinsThisRun: 0,
            currentLane: 1,
            lanes: [-1.75, 0, 1.75],
            gameMode: 'normal',
            currentEnv: 'grid',
            lastEnvChange: 0,
            spawnTimer: null,
            factTimer: null,
            selectedScores: new Set(),
            deletionHistory: [],
            audioContext: null,
            masterVolume: 1.0,
            soundEnabled: true,
            musicEnabled: true
        };
        
        // Player Data
        let playerData = {
            username: '',
            coins: 100,
            matchesPlayed: 0,
            highScores: [],
            unlockedSkins: ['skin_default'],
            equippedSkin: 'skin_default',
            settings: {
                masterVolume: 100,
                soundEnabled: true,
                musicEnabled: true
            }
        };
        
        // Shop Items
        const SHOP_ITEMS = {
            skins: [
                { id: 'skin_default', name: 'Default', color: 0x00d2ff, price: 0, emoji: 'üîµ' },
                { id: 'skin_neon', name: 'Neon Green', color: 0x00ff00, price: 100, emoji: 'üíö' },
                { id: 'skin_fire', name: 'Fire', color: 0xff4400, price: 150, emoji: 'üî•' },
                { id: 'skin_ice', name: 'Ice', color: 0x00ffff, price: 200, emoji: '‚ùÑÔ∏è' },
                { id: 'skin_rainbow', name: 'Rainbow', color: 0xffffff, price: 500, emoji: 'üåà' },
                { id: 'skin_galaxy', name: 'Galaxy', color: 0x8a2be2, price: 750, emoji: 'üåå' },
                { id: 'skin_gold', name: 'Golden', color: 0xffd700, price: 1000, emoji: '‚≠ê' }
            ]
        };
        
        // Prime Facts
        const PRIME_FACTS = [
            "2 is the only even prime number.",
            "Prime numbers become less frequent as numbers get larger.",
            "The largest known prime has over 24 million digits!",
            "Prime numbers are used in cryptography to secure data.",
            "1 is not considered a prime number.",
            "Every prime number greater than 3 is either 1 more or 1 less than a multiple of 6.",
            "There are infinite prime numbers (proved by Euclid).",
            "Twin primes are pairs of primes that differ by 2 (like 11 and 13).",
            "No prime number greater than 5 ends in 5.",
            "The word 'prime' comes from Latin 'primus' meaning 'first'."
        ];
        
        // ==================== INITIALIZATION ====================
        async function initGame() {
            try {
                // Update loading progress
                updateLoader(10, 'Loading game engine...');
                
                // Load player data
                loadPlayerData();
                
                // Initialize Three.js
                await initThreeJS();
                updateLoader(30, 'Setting up game world...');
                
                // Initialize audio
                initAudio();
                updateLoader(50, 'Loading sounds...');
                
                // Setup game world
                setupGameWorld();
                updateLoader(80, 'Preparing UI...');
                
                // Setup event listeners
                setupEventListeners();
                updateLoader(90, 'Finalizing...');
                
                // Hide loader and show menu
                setTimeout(() => {
                    document.getElementById('loader').style.opacity = '0';
                    setTimeout(() => {
                        document.getElementById('loader').style.display = 'none';
                        showScreen('menu');
                        
                        // Auto-focus username input if needed
                        if (!playerData.username) {
                            showScreen('name-prompt');
                            document.getElementById('username-input').focus();
                        }
                    }, 500);
                }, 1000);
                
                gameState.isInitialized = true;
                console.log('Game initialized successfully!');
                
            } catch (error) {
                console.error('Game initialization failed:', error);
                document.getElementById('loadingText').textContent = 'Error loading game. Please refresh.';
                document.getElementById('loadingText').style.color = '#ff4444';
            }
        }
        
        function updateLoader(percent, text) {
            document.getElementById('progressBar').style.width = percent + '%';
            document.getElementById('loadingText').textContent = text;
        }
        
        // ==================== THREE.JS SETUP ====================
        async function initThreeJS() {
            return new Promise((resolve, reject) => {
                try {
                    // Check if Three.js is loaded
                    if (typeof THREE === 'undefined') {
                        throw new Error('Three.js failed to load');
                    }
                    
                    // Create scene
                    gameState.scene = new THREE.Scene();
                    gameState.scene.fog = new THREE.Fog(0x000000, 10, 100);
                    
                    // Create camera
                    gameState.camera = new THREE.PerspectiveCamera(
                        75, 
                        window.innerWidth / window.innerHeight, 
                        0.1, 
                        1000
                    );
                    gameState.camera.position.set(0, 5, 5);
                    
                    // Create renderer
                    gameState.renderer = new THREE.WebGLRenderer({ 
                        antialias: true,
                        alpha: false,
                        powerPreference: 'high-performance'
                    });
                    
                    gameState.renderer.setSize(window.innerWidth, window.innerHeight);
                    gameState.renderer.shadowMap.enabled = true;
                    gameState.renderer.shadowMap.type = THREE.PCFSoftShadowMap;
                    gameState.renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
                    
                    const container = document.getElementById('game-container');
                    container.appendChild(gameState.renderer.domElement);
                    
                    resolve();
                } catch (error) {
                    reject(error);
                }
            });
        }
        
        function setupGameWorld() {
            // Lighting
            const ambientLight = new THREE.AmbientLight(0x222222);
            gameState.scene.add(ambientLight);
            
            const directionalLight = new THREE.DirectionalLight(0x00d2ff, 1.2);
            directionalLight.position.set(10, 20, 5);
            directionalLight.castShadow = true;
            gameState.scene.add(directionalLight);
            
            // Road
            const roadGeo = new THREE.PlaneGeometry(20, 400);
            const roadMat = new THREE.MeshStandardMaterial({ 
                color: 0x050515,
                roughness: 0.6
            });
            
            gameState.road = new THREE.Mesh(roadGeo, roadMat);
            gameState.road.rotation.x = -Math.PI / 2;
            gameState.road.position.z = -180;
            gameState.road.receiveShadow = true;
            gameState.scene.add(gameState.road);
            
            // Lane markers
            const laneGeo = new THREE.PlaneGeometry(0.08, 400);
            const laneMat = new THREE.MeshBasicMaterial({ color: 0x00d2ff });
            
            [-1.75, 1.75].forEach(x => {
                const lane = new THREE.Mesh(laneGeo, laneMat);
                lane.rotation.x = -Math.PI / 2;
                lane.position.set(x, 0.01, -180);
                gameState.scene.add(lane);
            });
            
            // Grid
            gameState.grid = new THREE.GridHelper(400, 80, 0x00d2ff, 0x111111);
            gameState.grid.position.z = -180;
            gameState.scene.add(gameState.grid);
            
            // Pillars
            const pillarGeo = new THREE.CylinderGeometry(0.3, 0.3, 6, 12);
            const pillarMat = new THREE.MeshStandardMaterial({ 
                color: 0x00d2ff, 
                emissive: 0x00d2ff, 
                emissiveIntensity: 1.2 
            });
            
            for (let i = 0; i < 30; i++) {
                const pillar = new THREE.Mesh(pillarGeo, pillarMat);
                pillar.position.set(Math.random() > 0.5 ? 7 : -7, 3, -i * 15);
                pillar.castShadow = true;
                gameState.scene.add(pillar);
                gameState.pillars.push(pillar);
            }
            
            // Create player
            createPlayer();
            
            // Start animation loop
            animate();
        }
        
        function createPlayer() {
            if (gameState.player) {
                gameState.scene.remove(gameState.player);
            }
            
            gameState.player = new THREE.Group();
            const skin = SHOP_ITEMS.skins.find(s => s.id === playerData.equippedSkin);
            
            gameState.playerCore = new THREE.Mesh(
                new THREE.SphereGeometry(0.4, 16, 16),
                new THREE.MeshStandardMaterial({ 
                    color: skin ? skin.color : 0x00d2ff,
                    emissive: skin ? skin.color : 0x00d2ff,
                    emissiveIntensity: 2
                })
            );
            gameState.playerCore.castShadow = true;
            gameState.player.add(gameState.playerCore);
            gameState.player.position.y = 1;
            gameState.scene.add(gameState.player);
            
            gameState.camera.lookAt(gameState.player.position);
        }
        
        // ==================== GAME LOGIC ====================
        function startGame() {
            if (!playerData.username) {
                showScreen('name-prompt');
                document.getElementById('username-input').focus();
                return;
            }
            
            // Reset game state
            gameState.isPlaying = true;
            gameState.isPaused = false;
            gameState.score = 0;
            gameState.distance = 0;
            gameState.speed = 0.3;
            gameState.coinsThisRun = 0;
            gameState.currentLane = 1;
            gameState.currentEnv = 'grid';
            gameState.lastEnvChange = 0;
            
            // Reset player position
            gameState.player.position.x = gameState.lanes[1];
            gameState.player.position.y = 1;
            
            // Clear existing numbers
            gameState.activeNumbers.forEach(n => gameState.scene.remove(n));
            gameState.activeNumbers = [];
            
            // Update HUD
            document.getElementById('hud').hidden = false;
            
            // Show mobile controls on mobile
            if (isMobile()) {
                document.querySelector('.mobile-controls').hidden = false;
            }
            
            // Hide menu
            showScreen(null);
            
            // Start spawning
            spawnWave();
            
            // Update player skin
            updatePlayerSkin();
            
            showNotification('Game started! Good luck!', 'success');
        }
        
        function spawnWave() {
            if (!gameState.isPlaying || gameState.isPaused) return;
            if (gameState.spawnTimer) clearTimeout(gameState.spawnTimer);
            
            const value = Math.floor(Math.random() * 97) + 2;
            const isPrimeValue = isPrime(value);
            
            // Create canvas for the number
            const canvas = document.createElement('canvas');
            canvas.width = 256;
            canvas.height = 256;
            const ctx = canvas.getContext('2d');
            
            // Draw number
            ctx.fillStyle = "white";
            ctx.font = "bold 140px Arial";
            ctx.textAlign = "center";
            ctx.textBaseline = "middle";
            ctx.fillText(value, 128, 128);
            
            // Determine color
            let color = isPrimeValue ? 0x00ff00 : 0xff4444;
            if (gameState.gameMode === 'hardcore' && !isPrimeValue) {
                color = 0x333333;
            }
            
            // Create sprite
            const texture = new THREE.CanvasTexture(canvas);
            const material = new THREE.SpriteMaterial({ 
                map: texture, 
                color: color 
            });
            
            const sprite = new THREE.Sprite(material);
            const lane = Math.floor(Math.random() * 3);
            sprite.position.set(gameState.lanes[lane], 1.5, -80);
            sprite.scale.set(4, 4, 1);
            sprite.userData = { 
                value: value, 
                isCorrect: isPrimeValue 
            };
            
            gameState.scene.add(sprite);
            gameState.activeNumbers.push(sprite);
            
            // Schedule next spawn
            let spawnRate = gameState.gameMode === 'hardcore' ? 600 : Math.max(600, 2000 - gameState.distance * 1.5);
            gameState.spawnTimer = setTimeout(spawnWave, spawnRate);
        }
        
        function isPrime(n) {
            if (n <= 1) return false;
            if (n <= 3) return true;
            if (n % 2 === 0 || n % 3 === 0) return false;
            for (let i = 5; i * i <= n; i += 6) {
                if (n % i === 0 || n % (n + 2) === 0) return false;
            }
            return true;
        }
        
        function gameOver(reason) {
            if (!gameState.isPlaying) return;
            
            gameState.isPlaying = false;
            gameState.isPaused = false;
            
            if (gameState.spawnTimer) clearTimeout(gameState.spawnTimer);
            if (gameState.factTimer) clearInterval(gameState.factTimer);
            
            // Update player data
            playerData.matchesPlayed++;
            
            // Calculate earnings
            let multiplier = 1;
            if (gameState.gameMode === 'hardcore') multiplier = 2;
            
            let earned = Math.floor(gameState.coinsThisRun * multiplier);
            playerData.coins += earned;
            
            // Add to high scores
            if (gameState.score > 0) {
                playerData.highScores.push({
                    score: gameState.score,
                    distance: Math.floor(gameState.distance),
                    coins: gameState.coinsThisRun,
                    mode: gameState.gameMode,
                    timestamp: new Date().toISOString(),
                    username: playerData.username
                });
                
                // Sort and keep top 10
                playerData.highScores.sort((a, b) => b.score - a.score);
                playerData.highScores = playerData.highScores.slice(0, 10);
            }
            
            savePlayerData();
            
            // Update game over screen
            document.getElementById('reason').textContent = reason;
            document.getElementById('final-stats').textContent = 
                `Distance: ${Math.floor(gameState.distance)}m | Score: ${gameState.score} | Mode: ${gameState.gameMode.toUpperCase()}`;
            document.getElementById('coins-earned').innerHTML = 
                `Coins earned: <span style="color:#ffd700">+${earned}</span>`;
            
            // Hide HUD and mobile controls
            document.getElementById('hud').hidden = true;
            document.querySelector('.mobile-controls').hidden = true;
            
            // Show game over screen
            showScreen('game-over');
            
            // Play sound
            playMissSound();
        }
        
        function restartGame() {
            // Clear existing numbers
            gameState.activeNumbers.forEach(n => gameState.scene.remove(n));
            gameState.activeNumbers = [];
            
            // Start new game
            startGame();
        }
        
        // ==================== ANIMATION LOOP ====================
        function animate() {
            requestAnimationFrame(animate);
            
            if (gameState.isPlaying && !gameState.isPaused) {
                // Update distance and speed
                gameState.distance += gameState.speed;
                
                // Update speed based on mode
                if (gameState.gameMode === 'slowburn') {
                    gameState.speed += 0.00005;
                } else if (gameState.gameMode === 'hardcore') {
                    gameState.speed = Math.min(0.7, 0.5 + gameState.distance * 0.0003);
                } else {
                    gameState.speed = Math.min(0.5, 0.3 + gameState.distance * 0.0002);
                }
                
                // Move player
                const targetX = gameState.lanes[gameState.currentLane];
                gameState.player.position.x += (targetX - gameState.player.position.x) * 0.15;
                
                // Move road and grid
                gameState.road.position.z += gameState.speed;
                gameState.grid.position.z += gameState.speed;
                
                if (gameState.road.position.z > 20) gameState.road.position.z = -180;
                if (gameState.grid.position.z > 20) gameState.grid.position.z = -180;
                
                // Move pillars
                gameState.pillars.forEach(p => {
                    p.position.z += gameState.speed;
                    if (p.position.z > 10) {
                        p.position.z = -400;
                    }
                });
                
                // Update HUD
                document.getElementById('dist-val').textContent = Math.floor(gameState.distance) + 'm';
                document.getElementById('score-val').textContent = gameState.score;
                document.getElementById('coins-val').textContent = gameState.coinsThisRun;
                document.getElementById('speed-val').textContent = gameState.speed.toFixed(2);
                
                // Check collisions
                for (let i = gameState.activeNumbers.length - 1; i >= 0; i--) {
                    const number = gameState.activeNumbers[i];
                    number.position.z += gameState.speed;
                    
                    // Check collision with player
                    if (number.position.distanceTo(gameState.player.position) < 1.5) {
                        if (number.userData.isCorrect) {
                            // Collect prime
                            gameState.score += 10;
                            gameState.coinsThisRun += 5;
                            gameState.scene.remove(number);
                            gameState.activeNumbers.splice(i, 1);
                            playCollectSound();
                        } else {
                            // Hit composite
                            gameOver(`${number.userData.value} is a Composite number!`);
                            return;
                        }
                    } else if (number.position.z > 15) {
                        // Number passed by
                        if (number.userData.isCorrect) {
                            gameOver(`You missed a Prime: ${number.userData.value}!`);
                            return;
                        }
                        gameState.scene.remove(number);
                        gameState.activeNumbers.splice(i, 1);
                    }
                }
            }
            
            // Update camera
            gameState.camera.position.x += (gameState.player.position.x - gameState.camera.position.x) * 0.05;
            gameState.camera.lookAt(gameState.player.position.x, gameState.player.position.y, gameState.player.position.z);
            
            // Render
            if (gameState.renderer && gameState.scene && gameState.camera) {
                gameState.renderer.render(gameState.scene, gameState.camera);
            }
        }
        
        // ==================== UI MANAGEMENT ====================
        function showScreen(screenId) {
            // Hide all screens
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            
            // Hide modals
            document.querySelectorAll('.modal').forEach(modal => {
                modal.classList.remove('active');
            });
            
            document.getElementById('overlay').classList.remove('active');
            
            // Show requested screen
            if (screenId) {
                document.getElementById(screenId).classList.add('active');
            }
        }
        
        function backToMenu() {
            // Stop game
            gameState.isPlaying = false;
            gameState.isPaused = false;
            
            if (gameState.spawnTimer) clearTimeout(gameState.spawnTimer);
            if (gameState.factTimer) clearInterval(gameState.factTimer);
            
            // Clear numbers
            gameState.activeNumbers.forEach(n => gameState.scene.remove(n));
            gameState.activeNumbers = [];
            
            // Hide HUD and mobile controls
            document.getElementById('hud').hidden = true;
            document.querySelector('.mobile-controls').hidden = true;
            
            // Show menu
            showScreen('menu');
            
            // Update shop and leaderboard
            updateShopDisplay();
            updateLeaderboard();
            updateMenuCoins();
        }
        
        function setGameMode(mode) {
            gameState.gameMode = mode;
            document.querySelectorAll('.mode-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            showNotification(`${mode.toUpperCase()} mode selected`);
        }
        
        function saveUsername() {
            const input = document.getElementById('username-input');
            const username = input.value.trim();
            
            if (!username) {
                input.style.borderColor = '#ff4444';
                showNotification('Please enter a name!', 'error');
                return;
            }
            
            if (username.length < 2) {
                input.style.borderColor = '#ff4444';
                showNotification('Name must be at least 2 characters', 'error');
                return;
            }
            
            if (username.length > 15) {
                input.style.borderColor = '#ff4444';
                showNotification('Name must be 15 characters or less', 'error');
                return;
            }
            
            playerData.username = username;
            savePlayerData();
            
            input.style.borderColor = '#00d2ff';
            showNotification(`Welcome, ${username}!`, 'success');
            
            // Start game
            setTimeout(() => {
                startGame();
            }, 500);
        }
        
        // ==================== SHOP SYSTEM ====================
        function openShop() {
            document.getElementById('shop').classList.add('active');
            document.getElementById('overlay').classList.add('active');
            updateShopDisplay();
        }
        
        function closeShop() {
            document.getElementById('shop').classList.remove('active');
            document.getElementById('overlay').classList.remove('active');
        }
        
        function updateShopDisplay() {
            const container = document.getElementById('shop-items');
            container.innerHTML = '';
            
            SHOP_ITEMS.skins.forEach(skin => {
                const isUnlocked = playerData.unlockedSkins.includes(skin.id);
                const isEquipped = playerData.equippedSkin === skin.id;
                
                const item = document.createElement('div');
                item.className = `shop-item ${isEquipped ? 'equipped' : ''}`;
                item.onclick = () => purchaseSkin(skin.id);
                item.style.setProperty('--item-color', `#${skin.color.toString(16).padStart(6, '0')}`);
                
                const status = isEquipped ? 'EQUIPPED' : (isUnlocked ? 'OWNED' : `${skin.price} coins`);
                const statusColor = isEquipped ? '#00ff00' : (isUnlocked ? '#ffd700' : '#ffd700');
                
                item.innerHTML = `
                    <div class="item-preview">${skin.emoji}</div>
                    <div style="font-weight: bold; color: white;">${skin.name}</div>
                    <div style="color: ${statusColor}; font-weight: bold; margin: 5px 0;">${status}</div>
                    <div style="font-size: 12px; color: #aaa;">${skin.price === 0 ? 'Free' : `${skin.price} coins`}</div>
                `;
                
                container.appendChild(item);
            });
            
            document.getElementById('shop-coins').textContent = playerData.coins;
        }
        
        function purchaseSkin(skinId) {
            const skin = SHOP_ITEMS.skins.find(s => s.id === skinId);
            
            if (playerData.unlockedSkins.includes(skinId)) {
                // Already owned - equip it
                playerData.equippedSkin = skinId;
                savePlayerData();
                updateShopDisplay();
                createPlayer();
                showNotification(`${skin.name} equipped!`, 'success');
            } else if (playerData.coins >= skin.price) {
                // Purchase
                playerData.coins -= skin.price;
                playerData.unlockedSkins.push(skinId);
                playerData.equippedSkin = skinId;
                savePlayerData();
                updateShopDisplay();
                createPlayer();
                showNotification(`${skin.name} purchased!`, 'success');
            } else {
                showNotification(`Need ${skin.price - playerData.coins} more coins!`, 'error');
            }
        }
        
        function updatePlayerSkin() {
            const skin = SHOP_ITEMS.skins.find(s => s.id === playerData.equippedSkin);
            if (skin && gameState.playerCore) {
                if (skin.id === 'skin_rainbow') {
                    // Rainbow effect
                    const time = Date.now() * 0.005;
                    const r = Math.sin(time) * 0.5 + 0.5;
                    const g = Math.sin(time + 2) * 0.5 + 0.5;
                    const b = Math.sin(time + 4) * 0.5 + 0.5;
                    gameState.playerCore.material.color.setRGB(r, g, b);
                    gameState.playerCore.material.emissive.setRGB(r, g, b);
                } else {
                    gameState.playerCore.material.color.setHex(skin.color);
                    gameState.playerCore.material.emissive.setHex(skin.color);
                }
            }
        }
        
        // ==================== LEADERBOARD ====================
        function openLeaderboard() {
            document.getElementById('leaderboard').classList.add('active');
            document.getElementById('overlay').classList.add('active');
            updateLeaderboard();
        }
        
        function closeLeaderboard() {
            document.getElementById('leaderboard').classList.remove('active');
            document.getElementById('overlay').classList.remove('active');
        }
        
        function updateLeaderboard() {
            const container = document.getElementById('lb-entries');
            
            if (playerData.highScores.length === 0) {
                container.innerHTML = '<div style="color: #666; text-align: center; padding: 40px;">No scores yet. Play a game!</div>';
                return;
            }
            
            let html = '';
            playerData.highScores.forEach((score, index) => {
                const date = new Date(score.timestamp).toLocaleDateString();
                html += `
                    <div class="leaderboard-entry">
                        <div style="display: flex; align-items: center; gap: 15px;">
                            <div style="color: #ffd700; font-weight: bold; font-size: 1.2em;">#${index + 1}</div>
                            <div>
                                <div style="font-weight: bold;">${score.username}</div>
                                <div style="font-size: 12px; color: #aaa;">${date} ‚Ä¢ ${score.mode}</div>
                            </div>
                        </div>
                        <div style="text-align: right;">
                            <div style="color: #00ff00; font-weight: bold; font-size: 1.2em;">${score.score}</div>
                            <div style="font-size: 12px; color: #aaa;">${Math.floor(score.distance)}m</div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        // ==================== SOUND SYSTEM ====================
        function initAudio() {
            try {
                gameState.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                
                // Load settings
                gameState.masterVolume = (playerData.settings.masterVolume || 100) / 100;
                gameState.soundEnabled = playerData.settings.soundEnabled !== false;
                gameState.musicEnabled = playerData.settings.musicEnabled !== false;
                
                // Update UI
                document.getElementById('master-volume').value = (gameState.masterVolume * 100);
                document.getElementById('sound-toggle').checked = gameState.soundEnabled;
                document.getElementById('music-toggle').checked = gameState.musicEnabled;
                
            } catch (error) {
                console.log('Audio not supported:', error);
            }
        }
        
        function playCollectSound() {
            if (!gameState.soundEnabled || !gameState.audioContext) return;
            
            try {
                const oscillator = gameState.audioContext.createOscillator();
                const gainNode = gameState.audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(gameState.audioContext.destination);
                
                oscillator.frequency.value = 800;
                oscillator.type = 'sine';
                
                gainNode.gain.setValueAtTime(0, gameState.audioContext.currentTime);
                gainNode.gain.linearRampToValueAtTime(gameState.masterVolume * 0.2, gameState.audioContext.currentTime + 0.01);
                gainNode.gain.exponentialRampToValueAtTime(0.001, gameState.audioContext.currentTime + 0.3);
                
                oscillator.start();
                oscillator.stop(gameState.audioContext.currentTime + 0.3);
            } catch (error) {
                // Silent fail
            }
        }
        
        function playMissSound() {
            if (!gameState.soundEnabled || !gameState.audioContext) return;
            
            try {
                const oscillator = gameState.audioContext.createOscillator();
                const gainNode = gameState.audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(gameState.audioContext.destination);
                
                oscillator.frequency.value = 200;
                oscillator.type = 'sawtooth';
                
                gainNode.gain.setValueAtTime(0, gameState.audioContext.currentTime);
                gainNode.gain.linearRampToValueAtTime(gameState.masterVolume * 0.15, gameState.audioContext.currentTime + 0.01);
                gainNode.gain.exponentialRampToValueAtTime(0.001, gameState.audioContext.currentTime + 0.5);
                
                oscillator.start();
                oscillator.stop(gameState.audioContext.currentTime + 0.5);
            } catch (error) {
                // Silent fail
            }
        }
        
        function toggleSoundSettings() {
            document.getElementById('sound-settings').classList.add('active');
            document.getElementById('overlay').classList.add('active');
        }
        
        function closeSoundSettings() {
            document.getElementById('sound-settings').classList.remove('active');
            document.getElementById('overlay').classList.remove('active');
        }
        
        function saveSoundSettings() {
            gameState.masterVolume = document.getElementById('master-volume').value / 100;
            gameState.soundEnabled = document.getElementById('sound-toggle').checked;
            gameState.musicEnabled = document.getElementById('music-toggle').checked;
            
            playerData.settings.masterVolume = gameState.masterVolume * 100;
            playerData.settings.soundEnabled = gameState.soundEnabled;
            playerData.settings.musicEnabled = gameState.musicEnabled;
            
            savePlayerData();
            showNotification('Sound settings saved!', 'success');
            closeSoundSettings();
        }
        
        // ==================== INPUT HANDLING ====================
        function setupEventListeners() {
            // Keyboard controls
            window.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    if (gameState.isPlaying) {
                        backToMenu();
                    }
                    return;
                }
                
                if (e.key === ' ') {
                    e.preventDefault();
                    togglePause();
                    return;
                }
                
                if (!gameState.isPlaying || gameState.isPaused) return;
                
                if ((e.key === 'ArrowLeft' || e.key === 'a') && gameState.currentLane > 0) {
                    gameState.currentLane--;
                }
                if ((e.key === 'ArrowRight' || e.key === 'd') && gameState.currentLane < 2) {
                    gameState.currentLane++;
                }
            });
            
            // Window resize
            window.addEventListener('resize', () => {
                if (gameState.camera && gameState.renderer) {
                    gameState.camera.aspect = window.innerWidth / window.innerHeight;
                    gameState.camera.updateProjectionMatrix();
                    gameState.renderer.setSize(window.innerWidth, window.innerHeight);
                }
            });
            
            // Prevent context menu on right click
            window.addEventListener('contextmenu', (e) => {
                e.preventDefault();
            });
            
            // Prevent pull-to-refresh on mobile
            document.addEventListener('touchmove', (e) => {
                if (gameState.isPlaying) {
                    e.preventDefault();
                }
            }, { passive: false });
        }
        
        // Mobile controls
        function moveLeft() {
            if (gameState.isPlaying && !gameState.isPaused && gameState.currentLane > 0) {
                gameState.currentLane--;
            }
        }
        
        function moveRight() {
            if (gameState.isPlaying && !gameState.isPaused && gameState.currentLane < 2) {
                gameState.currentLane++;
            }
        }
        
        function stopMove() {
            // Optional: Add any cleanup for touch controls
        }
        
        function togglePause() {
            if (!gameState.isPlaying) return;
            
            gameState.isPaused = !gameState.isPaused;
            if (gameState.isPaused) {
                showNotification('Game Paused', 'info');
                if (gameState.spawnTimer) clearTimeout(gameState.spawnTimer);
            } else {
                showNotification('Game Resumed', 'success');
                spawnWave();
            }
        }
        
        // ==================== DATA MANAGEMENT ====================
        function loadPlayerData() {
            try {
                const savedData = localStorage.getItem(CONFIG.localStoragePrefix + 'playerData');
                if (savedData) {
                    const parsed = JSON.parse(savedData);
                    playerData = { ...playerData, ...parsed };
                }
            } catch (error) {
                console.log('Could not load saved data:', error);
            }
        }
        
        function savePlayerData() {
            try {
                localStorage.setItem(CONFIG.localStoragePrefix + 'playerData', JSON.stringify(playerData));
            } catch (error) {
                console.log('Could not save data:', error);
            }
        }
        
        function updateMenuCoins() {
            // Update coin display if needed
        }
        
        // ==================== UTILITY FUNCTIONS ====================
        function showNotification(message, type = 'info') {
            // Simple notification - you can enhance this
            console.log(`[${type}] ${message}`);
        }
        
        function isMobile() {
            return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        }
        
        // ==================== INITIALIZE GAME ====================
        // Start the game when page loads
        window.addEventListener('load', initGame);
        
        // Make functions available globally
        window.startGame = startGame;
        window.backToMenu = backToMenu;
        window.restartGame = restartGame;
        window.setGameMode = setGameMode;
        window.saveUsername = saveUsername;
        window.openShop = openShop;
        window.closeShop = closeShop;
        window.openLeaderboard = openLeaderboard;
        window.closeLeaderboard = closeLeaderboard;
        window.toggleSoundSettings = toggleSoundSettings;
        window.closeSoundSettings = closeSoundSettings;
        window.saveSoundSettings = saveSoundSettings;
        window.moveLeft = moveLeft;
        window.moveRight = moveRight;
        window.stopMove = stopMove;
    </script>
</body>
</html>
